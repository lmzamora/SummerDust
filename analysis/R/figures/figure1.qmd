---
title: "Create Figure 1"
author: "Lauren Zamora"
format: html
editor: visual
---

## Figure 1

This figure shows, over Arctic sea ice, (a) The likelihood of clouds at different altitudes being classified by CloudSat as either liquid, mixed, or ice phase, (b) the estimated dust-driven increases in cloud glaciation in different meteorological conditions, and (c) the meteorological and aerosol parameters that best predict how glaciation changes within meteorological bins, based on deviance explained in a generalized additive model.

## Running Code

For **Figure 1** you first load the following libraries:

```{r}
library(data.table)
library(scales)
library(devtools)
```

For **Figure 1a** we loaded the following datasets, which represent the fraction of liquid, mixed phase, and ice clouds in the study region/period:

```{r}
load("../../data/derived_data/fCliq.RData")
load("../../data/derived_data/fCmpc.RData")
load("../../data/derived_data/fCice.RData")
```

We plotted the fractions at average altitudes of 1-8 km, and found the maximum values for the x-axis of Figure 1a:

```{r}
alt<-1:8
xmax<-max(si_fCliq,si_fCmpc,si_fCice)
```

Then we looked at the data for Figure 1 a:

```{r}
plot(si_fCliq,alt,ty="l",col="#d7191c",xlim=c(0,100), lwd=5,yaxs="i",las=1,xaxs="i",cex.axis=1.4,cex.lab=1.4, ylab="Altitude (km)", xlab="Cloud phase frequency (%)")
points(si_fCmpc,alt,ty="l",col="#fdae61", lwd=5)
points(si_fCice,alt,ty="l",col="#2c7bb6", lwd=5)
legend(53, 4, legend=c("Liquid", "Mixed","Ice"), col=c("#d7191c", "#fdae61", "#2c7bb6"), lty=1:2, cex=0.8,lwd=5)
text(80,1.5, substitute(paste(bold('(a)'))), cex=1.5)

```

For **Figure 1b**, load the del2 dataset, which represents the estimated dust-driven increases in cloud glaciation in different meteorological conditions. Also load the corresponding del2p dataset that represents whether these differences were significant (p\< 0.05):

```{r}
load("../../data/derived_data/del2.RData")
load("../../data/derived_data/grid2.RData")
load("../../data/derived_data/grid2p.RData")
load("../../data/derived_data/sizegrid.RData")
```

Set the variables

```{r}
var1<-"merT"
var2<-"temp"
var3<-"merQV"
var1range<-seq(-70,30,7.5/2)
var2range<-seq(-70,30,7.5/2)
var3range<-seq(0,0.0145, 0.001) 
```

Plot the figure:

```{r}
source_url('https://gist.github.com/menugget/7689145/raw/dac746aa322ca4160a5fe66c70fec16ebe26faf9/image.scale.2.r')
pal=colorRampPalette(rev(c("deepskyblue4","deepskyblue3","deepskyblue2","grey","orangered","red","darkred")))
ncol=100
colors<-pal(ncol)
zlim<-c(-5,5)
seq_values<-seq(from=zlim[1], to=zlim[2],length.out=length(colors)+1)
res=200
pmin<-0.05

xmin<-min(del2$var1bin,na.rm=T)
xmax<-max(del2$var1bin,na.rm=T) 
ymin<-min(del2$var3bin,na.rm=T) 
ymax<-max(del2$var3bin,na.rm=T) 
xax<-var1range[xmin:xmax] + (var1range[2]-var1range[1])/2  #Because findInterval gives low interval boundary
yax<-var3range[ymin:ymax]+ (var3range[2]-var3range[1])/2  #Because findInterval gives low interval boundary
xmn<-min(xax)-(var1range[2]-var1range[1])/2
xmx<-max(xax)
ymn<-min(yax)
ymx<-max(yax)

cvals<-findInterval(as.numeric(grid2),seq_values)
cvals[cvals<=0]<-1
cvals[cvals>=101]<-100
color<-colors[cvals]
color<-matrix(color,dim(grid2)[1],dim(grid2)[2])

#eval(parse(t=paste0("png('dcP_fdust_",var1,"_",var3,"_p_l3_si.png', width=5, height=4, units='in', res=200)")))
layout(matrix(c(1,2), nrow=1, ncol=2), widths=c(4,1), heights=c(4,4))
layout.show(2)
par(mar=c(4,4,2,2))

image(xax,yax,grid2, col=NA,zlim=zlim,xlab="MERRA-2 T (C)",ylab="MERRA-2 specific humidity (kg/kg)", xlim=c(xmn,0),ylim=c(0,ymx)) 
 
 for(l in 1:dim(grid2)[1]) {
  for(m in 1:dim(grid2)[2]) {
  	if(!is.na(grid2p[l,m])&grid2p[l, m]>=0.05) {
      points(xax[l],yax[m], pch=1,col=color[l,m],lwd=0.5,cex=sizegrid[l,m])
    }
  }
}

for(l in 1:dim(grid2)[1]) {
  for(m in 1:dim(grid2)[2]) {
  	if(!is.na(grid2p[l,m])&grid2p[l, m]<0.05) {
      points(xax[l],yax[m], pch=16,col=color[l,m],lwd=1.1,cex=sizegrid[l,m])
    }
  }
}


eval(parse(t=paste0("text(-20,20,'n(cloud profiles) = ",round(sum(del2$alln)/1e6),"M')")))
par(mar=c(1,1,1,3))
breaks <- seq(zlim[1],zlim[2],length.out=11)
image.scale(grid2, col=pal(ncol),zlim=zlim, axis.pos=2,add.axis=F)
axis(4,at=breaks, las=2)
box()
#dev.off()

```
