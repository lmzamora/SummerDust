---
title: "Background for Supplementary Fig. 1"
author: "Lauren Zamora"
format: html
editor: visual
---

## Supplementary Figure 1

This figure shows the average frequency of CALIPSO dust aerosol layer occurrences and mean MERRA-2 and FLEXPART dust concentrations at different altitudes, along with the Pierson weighted R-squared for bins with \> 40 samples, weighted by the area of the different geographic bins. The size of the data is related to the geographic bin area. The dashed blue line is a qualitative marker between the lowest and highest observed dust layer frequencies.

## Running Code

For **Supplementary Figure 1** first load the following libraries:

```{r}
library(data.table)
library(geosphere)
```

This is a calculation of the Pierson weighted R-squared of mean dust vs. mean CALIPSO dust overlap across the different geographic bins, weighted by the area of the bins. Data are from Zamora et al., 2022. The ftop, fbase and ptop, pbase are the bottom and top altitudes (in km) of the layer in which the FLEXPART/MERRA-2 aerosol data are taken from. These vary because in MERRA-2 the data were based on pressure levels, and in FLEXPART we had to get values relative to sea level, not ground level.

Altitude ranges over which the mean dust, mean CALIPSO overlap, and mid-level height will be averaged will be at the FLEXPART vertical resolution, which is coarser than the MERRA-2 vertical resolution.

```{r}
zbins<-c(0,0.75, 1.5, 2, 4, 6, 8, 10, 15, 20)

```

The size (in degrees) of the longitude and latitude bins are chosen to strike a balance between maximizing sample size and minimizing random error:

```{r}
size.lon=7
size.lat=7 
```

This function finds the area of a polygon with the four points being the the low end of the grid + size of grid in degrees Coordinates are: min lon and lat; min lon, max lat (smallest of either 82 or max lat); max lon, max lat (smallest of either 82 or max lat); and max lon, min lat

```{r}
area.helper<-Vectorize(function(lonbin,latbin,size.lon,size.lat)areaPolygon(rbind(c(lonbin,latbin),c(lonbin,pmin(82,latbin+size.lat)),c(lonbin+size.lon,pmin(82,latbin+size.lat)),c(lonbin+size.lon,latbin))),c("lonbin","latbin","size.lat","size.lon"))  

```

Minimum number of samples in the geographic area for it to be included in the weighted mean:

```{r}
min.N=40
```

Load Zamora et al., 2022 data set 1 (relating the FLEXPART - CALIPSO comparison), look only at data over oceanic areas, between 0.25 and 10 km altitude, and with at least the minimum number of samples. Write out the area of the geographic bins:

```{r}
load("/Users/lzamora/Library/CloudStorage/OneDrive-NASA/NASA_Science/8000-5_R+D_project_files/ACMAP3/code/data_analysis/Figures/random/fdust_validation/fdust_ma.RData")
mall<-ma[ocean==1]
foo<-mall[fbase>.25&fbase<10,.(.N,meandust=mean(dust),mean_overlap=mean(CALIPSO_overlap), fmid=mean(ftop/2+fbase/2)),by=.(lonbin=size.lon*floor(lon/size.lon),latbin=size.lat*floor(lat/size.lat),zbin=findInterval(ftop,zbins))]
foo<-foo[N>=min.N]
#Zbin is which altitude group ftop fits into, and fmid is the middle of ftop and fbase at that lat/lon/alt
rm(mall)
foo[,area:=area.helper(lonbin,latbin,size.lon,size.lat)*1e-6]
foofo<-foo
fwrite(foofo,file="../../data/derived_data/SFig1_flexpart.csv",na=NA,quote=F)
```

Load Zamora et al., 2022 data set 2 (relating the MERRA-2 - CALIPSO comparison), look only at data over oceanic areas, between 0.25 and 10 km:

```{r}
load("/Users/lzamora/Library/CloudStorage/OneDrive-NASA/NASA_Science/8000-5_R+D_project_files/ACMAP3/code/data_analysis/Figures/random/fdust_validation/merra2_ma_v2.RData")
mall<-ma[ocean==1]
foo<-mall[pbase>.25&pbase<10,.(.N,meandust=mean(dust),mean_overlap=mean(CALIPSO_overlap), fmid=mean(ptop/2+pbase/2)),by=.(lonbin=size.lon*floor(lon/size.lon),latbin=size.lat*floor(lat/size.lat),zbin=findInterval(ptop,zbins))]
rm(mall)
foo[,area:=area.helper(lonbin,latbin,size.lon,size.lat)*1e-6]
foomo<-foo
fwrite(foomo,file="../../data/derived_data/SFig1_merra2.csv",na=NA,quote=F)
```
